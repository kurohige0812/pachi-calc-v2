<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>貯玉・現金・1250計算機</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='dark.css') }}">
</head>
<body class="bg-dark text-white px-3 py-4">

  <div class="container">

    <!-- 1. 貯玉計算機 -->
    <div class="mb-4 p-3 bg-secondary rounded">
      <h4>1. 貯玉計算機</h4>
      <div class="mb-2">
        <label>初期貯玉：</label>
        <input type="number" id="tama-initial" class="form-control mb-2">
        <label>現在の貯玉：</label>
        <input type="number" id="tama-current" class="form-control mb-2">
      </div>
      <button class="btn btn-primary" onclick="calcTama()">決定</button>
      <button class="btn btn-danger" onclick="resetTama()">リセット</button>
      <div class="mt-3" id="tama-result"></div>
    </div>

    <!-- 2. 現金計算機 -->
    <div class="mb-4 p-3 bg-secondary rounded">
      <h4>2. 現金計算機</h4>
      <label>枚目：</label>
      <select id="bill-number" class="form-select mb-2">
        {% for i in range(1, 31) %}
          <option value="{{ i }}">{{ i }}枚目</option>
        {% endfor %}
      </select>
      <label>貸玉残額（例：100→5）：</label>
      <input type="number" id="cash-value" class="form-control mb-2" min="5" max="100" step="5" value="100">
      <div class="mb-2">
        <button class="btn btn-primary" onclick="addCashEntry()">決定</button>
        <button class="btn btn-secondary" onclick="endCash()">稼働終了</button>
        <button class="btn btn-danger" onclick="resetCash()">リセット</button>
      </div>
      <div class="bg-dark p-2 rounded" id="cash-log" style="white-space:pre-wrap;"></div>
    </div>

    <!-- 3. 新1250計算機 -->
    <div class="p-3 bg-secondary rounded">
      <h4>3. 新1250計算機</h4>
      <div class="mb-2">
        <label>着席回転数：</label>
        <input type="number" id="base-spin" class="form-control mb-2">
        <button class="btn btn-secondary" onclick="resetSpin()">リセット</button>
      </div>
      <div class="mb-2">
        <label>現在回転数：</label>
        <input type="number" id="now-spin" class="form-control mb-2">
        <button class="btn btn-primary" onclick="calcSpin()">計算</button>
      </div>
      <div class="mb-2">
        <label>持ち玉：</label><input type="number" id="moti" class="form-control mb-2">
        <label>貯玉：</label><input type="number" id="tama" class="form-control mb-2">
        <label>現金：</label><input type="number" id="cash" class="form-control mb-2">
        <button class="btn btn-success" onclick="calc1250()">決定</button>
        <button class="btn btn-danger" onclick="reset1250()">リセット</button>
      </div>
      <div class="bg-dark p-2 rounded" id="result1250" style="white-space:pre-wrap;"></div>
    </div>

  </div>

<script>
// 貯玉
function calcTama() {
  let ini = parseInt($('#tama-initial').val());
  let now = parseInt($('#tama-current').val());
  if (isNaN(ini) || isNaN(now)) return;
  let used = ini - now;
  $('#tama-result').html(`<span class="copy-label" data-clip="${used}">使用貯玉 ${used} 玉</span>`);
}
function resetTama() {
  $('#tama-initial, #tama-current').val('');
  $('#tama-result').text('');
}

// 現金
let cashEntries = [];
let cashTotal = 0;

function addCashEntry() {
  const bill = parseInt($("#bill-number").val());
  const val = parseInt($("#cash-value").val());
  if (isNaN(bill) || isNaN(val)) return;
  const used = (bill - 1) * 10000 + (100 - val) * 100;
  const entry = { bill, val, used };
  cashEntries.push(entry);
  updateCashLog();
}

function updateCashLog() {
  let log = "";
  cashTotal = 0;
  for (let e of cashEntries) {
    log += `<div><span class="copy-label" data-clip="${e.bill}枚目: ${e.used}円">${e.bill}枚目 (${e.val}) → 使用金額：${e.used.toLocaleString()}円</span></div>`;
    cashTotal += e.used;
  }
  document.getElementById("cash-log").innerHTML = log;
}

function endCash() {
  let result = "";
  for (let i = 0; i < cashEntries.length; i++) {
    result += `${i + 1}台目使用金額：${cashEntries[i].used.toLocaleString()}円\n`;
  }
  result += `稼働使用合計金額：${cashTotal.toLocaleString()}円`;
  document.getElementById("cash-log").textContent = result;
  navigator.clipboard.writeText(result);
}

function resetCash() {
  cashEntries = [];
  cashTotal = 0;
  document.getElementById("cash-log").innerHTML = "";
}

// 1250計算
function resetSpin() {
  $('#base-spin').val('');
}
function calcSpin() {
  let base = parseInt($('#base-spin').val()) || 0;
  let now = parseInt($('#now-spin').val());
  if (isNaN(now)) return;
  let diff = now - base;
  $('#result1250').append(`回転数：${diff}回\n`);
}
function calc1250() {
  let moti = parseInt($('#moti').val()) || 0;
  let tama = parseInt($('#tama').val()) || 0;
  let cash = parseInt($('#cash').val()) || 0;
  let left = 1250, log = '';

  if (moti >= left) {
    log += `持ち玉 ${left} 使用\n`;
  } else {
    if (moti > 0) {
      log += `持ち玉 ${moti} 使用\n`; left -= moti;
    }
    if (tama >= left) {
      log += `貯玉 ${left} 使用\n`; left = 0;
    } else {
      if (tama > 0) {
        log += `貯玉 ${tama} 使用\n`; left -= tama;
      }
      if (left > 0) {
        log += `現金 ${left} 使用\n`;
      }
    }
  }
  $('#result1250').append(log + '\n');
}
function reset1250() {
  $('#moti, #tama, #cash').val('');
  $('#result1250').text('');
}

// コピー処理
function flashCopied(labelEl){
  const old = labelEl.parentNode.querySelector('.copied');
  if(old) old.remove();
  const tag = document.createElement('small');
  tag.className = 'copied ms-2 text-info';
  tag.textContent = 'コピーしました';
  labelEl.after(tag);
  setTimeout(()=> tag.remove(), 900);
}
function fallbackCopy(text){
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.select(); document.execCommand('copy');
  document.body.removeChild(ta);
}
document.addEventListener('click', e=>{
  const el = e.target;
  if(!el.classList.contains('copy-label')) return;
  const text = el.dataset.clip || '';
  if(navigator.clipboard){
    navigator.clipboard.writeText(text).catch(()=> fallbackCopy(text));
  }else{
    fallbackCopy(text);
  }
  flashCopied(el);
  el.classList.add('text-success');
  setTimeout(()=> el.classList.remove('text-success'), 700);
});
</script>

</body>
</html>
